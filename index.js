const { Client, LocalAuth } = require('whatsapp-web.js');
const fs = require('fs-extra');
const path = require('path');
const config = require('./config.json');
const logger = require('./src/utils/logger');
const commandHandler = require('./src/handlers/commandHandler');
const adsManager = require('./src/services/adsManager');
const apiService = require('./src/services/apiService');

class WhatsAppBot {
    constructor() {
        this.client = null;
        this.isReady = false;
        this.pairingCode = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.sessionPath = path.join(__dirname, '.wwebjs_auth');
        
        this.initializeBot();
    }
    
    async initializeBot() {
        try {
            logger.info('Inicializando WhatsApp Bot...', {
                version: config.botInfo.versao,
                numero: config.numeroBot
            });
            
            // Configurar cliente WhatsApp
            this.client = new Client({
                authStrategy: new LocalAuth({
                    clientId: 'bot-ads-client',
                    dataPath: this.sessionPath
                }),
                puppeteer: {
                    headless: true,
                    args: [
                        '--no-sandbox',
                        '--disable-setuid-sandbox',
                        '--disable-dev-shm-usage',
                        '--disable-accelerated-2d-canvas',
                        '--no-first-run',
                        '--no-zygote',
                        '--single-process',
                        '--disable-gpu'
                    ]
                },
                webVersionCache: {
                    type: 'remote',
                    remotePath: 'https://raw.githubusercontent.com/wppconnect-team/wa-version/main/html/2.2412.54.html'
                }
            });
            
            this.setupEventHandlers();
            
            // Inicializar cliente
            await this.client.initialize();
            
            // Solicitar c√≥digo de pareamento ap√≥s inicializa√ß√£o
            setTimeout(async () => {
                if (!this.isReady) {
                    await this.requestPairingCode(config.numeroBot);
                }
            }, 5000);
            
        } catch (error) {
            logger.error('Erro ao inicializar bot', error);
            await this.handleReconnection();
        }
    }
    
    setupEventHandlers() {
        // QR Code para pareamento
        this.client.on('qr', async (qr) => {
            logger.info('QR Code gerado, tentando obter c√≥digo de pareamento');
            console.log('\n‚ö†Ô∏è QR Code gerado, tentando obter c√≥digo de pareamento...\n');
            
            // Tentar solicitar c√≥digo de pareamento
            try {
                await this.requestPairingCode(config.numeroBot);
            } catch (error) {
                console.log('üì± N√£o foi poss√≠vel obter c√≥digo de pareamento, use o QR Code:');
                console.log(qr);
                console.log('\n');
            }
        });
        
        // C√≥digo de pareamento
        this.client.on('code', (code) => {
            this.pairingCode = code;
            logger.info('C√≥digo de pareamento gerado', { code });
            console.log('\nüîó C√ìDIGO DE PAREAMENTO:', code);
            console.log('üì± Digite este c√≥digo no seu WhatsApp Web\n');
        });
        
        // Cliente autenticado
        this.client.on('authenticated', () => {
            logger.info('Cliente autenticado com sucesso');
            console.log('‚úÖ Autenticado com sucesso!');
        });
        
        // Falha na autentica√ß√£o
        this.client.on('auth_failure', (message) => {
            logger.error('Falha na autentica√ß√£o', new Error(message));
            console.log('‚ùå Falha na autentica√ß√£o:', message);
        });
        
        // Cliente pronto
        this.client.on('ready', async () => {
            this.isReady = true;
            this.reconnectAttempts = 0;
            
            const clientInfo = this.client.info;
            logger.info('Bot conectado e pronto!', {
                numero: clientInfo.wid.user,
                nome: clientInfo.pushname,
                plataforma: clientInfo.platform
            });
            
            console.log('\nü§ñ BOT CONECTADO E PRONTO!');
            console.log(`üì± N√∫mero: ${clientInfo.wid.user}`);
            console.log(`üë§ Nome: ${clientInfo.pushname}`);
            console.log(`üíª Plataforma: ${clientInfo.platform}`);
            console.log(`üïê Hor√°rio: ${new Date().toLocaleString('pt-BR')}\n`);
            
            // Configurar cliente no gerenciador de an√∫ncios
            adsManager.setWhatsappClient(this.client);
            
            // Testar conex√£o com API
            if (apiService.isEnabled()) {
                const apiConnected = await apiService.testConnection();
                logger.info('Status da conex√£o com API', { connected: apiConnected });
                
                if (apiConnected) {
                    console.log('üåê Conex√£o com API Laravel: ‚úÖ Ativa');
                    // Sincronizar an√∫ncios na inicializa√ß√£o
                    await adsManager.syncWithApi();
                } else {
                    console.log('üåê Conex√£o com API Laravel: ‚ùå Falha');
                }
            } else {
                console.log('üåê API Laravel: ‚ö†Ô∏è Desabilitada');
            }
            
            // Enviar mensagem de inicializa√ß√£o para o dono
            await this.sendStartupMessage();
        });
        
        // Mensagens recebidas
        this.client.on('message', async (message) => {
            try {
                // Ignorar mensagens de status e pr√≥prias mensagens
                if (message.from === 'status@broadcast' || message.fromMe) {
                    return;
                }
                
                // Processar comando
                await commandHandler.handleMessage(message, this.client);
                
            } catch (error) {
                logger.error('Erro ao processar mensagem', error, {
                    from: message.from,
                    body: message.body
                });
            }
        });
        
        // Desconex√£o
        this.client.on('disconnected', async (reason) => {
            this.isReady = false;
            logger.warn('Cliente desconectado', { reason });
            console.log('‚ö†Ô∏è Cliente desconectado:', reason);
            
            if (config.autoReconnect) {
                await this.handleReconnection();
            }
        });
        
        // Erro no cliente
        this.client.on('error', (error) => {
            logger.error('Erro no cliente WhatsApp', error);
            console.log('‚ùå Erro no cliente:', error.message);
        });
        
        // Loading screen
        this.client.on('loading_screen', (percent, message) => {
            if (percent < 100) {
                console.log(`üì± Carregando WhatsApp Web: ${percent}% - ${message}`);
            }
        });
    }
    
    async handleReconnection() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            logger.error('M√°ximo de tentativas de reconex√£o atingido');
            console.log('‚ùå M√°ximo de tentativas de reconex√£o atingido. Bot ser√° encerrado.');
            process.exit(1);
        }
        
        this.reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
        
        logger.info(`Tentativa de reconex√£o ${this.reconnectAttempts}/${this.maxReconnectAttempts} em ${delay}ms`);
        console.log(`üîÑ Tentando reconectar em ${delay/1000}s... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
        
        setTimeout(async () => {
            try {
                if (this.client) {
                    await this.client.destroy();
                }
                await this.initializeBot();
            } catch (error) {
                logger.error('Erro na tentativa de reconex√£o', error);
                await this.handleReconnection();
            }
        }, delay);
    }
    
    async sendStartupMessage() {
        try {
            const ownerNumber = config.numeroDono + '@c.us';
            const stats = adsManager.getStats();
            
            const startupMessage = `ü§ñ *${config.botInfo.nome}* iniciado!\n\n` +
                                 `üïê *Hor√°rio:* ${new Date().toLocaleString('pt-BR')}\n` +
                                 `üì± *N√∫mero:* ${config.numeroBot}\n` +
                                 `üÜî *Vers√£o:* ${config.botInfo.versao}\n\n` +
                                 `üìä *Status:*\n` +
                                 `‚Ä¢ An√∫ncios ativos: ${stats.activeAds}\n` +
                                 `‚Ä¢ API Laravel: ${apiService.isEnabled() ? '‚úÖ' : '‚ùå'}\n` +
                                 `‚Ä¢ Timezone: ${config.timezone}\n\n` +
                                 `üí° Use *${config.prefix}help* para ver os comandos.`;
            
            await this.client.sendMessage(ownerNumber, startupMessage);
            logger.info('Mensagem de inicializa√ß√£o enviada para o dono');
            
        } catch (error) {
            logger.error('Erro ao enviar mensagem de inicializa√ß√£o', error);
        }
    }
    
    // M√©todo para obter c√≥digo de pareamento para um n√∫mero espec√≠fico
    async requestPairingCode(phoneNumber) {
        try {
            if (!phoneNumber) {
                phoneNumber = config.numeroBot;
            }
            
            // Limpar n√∫mero (remover caracteres n√£o num√©ricos)
            const cleanNumber = phoneNumber.replace(/\D/g, '');
            
            logger.info('Solicitando c√≥digo de pareamento', { numero: cleanNumber });
            
            const code = await this.client.requestPairingCode(cleanNumber);
            this.pairingCode = code;
            
            console.log('\nüîó C√ìDIGO DE PAREAMENTO SOLICITADO:');
            console.log(`üì± N√∫mero: ${cleanNumber}`);
            console.log(`üî¢ C√≥digo: ${code}`);
            console.log('üìã Digite este c√≥digo no WhatsApp Web do n√∫mero informado\n');
            
            return code;
            
        } catch (error) {
            logger.error('Erro ao solicitar c√≥digo de pareamento', error);
            throw error;
        }
    }
    
    // M√©todo para obter status do bot
    getStatus() {
        return {
            isReady: this.isReady,
            pairingCode: this.pairingCode,
            reconnectAttempts: this.reconnectAttempts,
            clientInfo: this.client?.info || null,
            adsStats: adsManager.getStats(),
            apiEnabled: apiService.isEnabled()
        };
    }
    
    // M√©todo para parar o bot graciosamente
    async stop() {
        try {
            logger.info('Parando bot...');
            console.log('üõë Parando bot...');
            
            if (this.client) {
                await this.client.destroy();
            }
            
            logger.info('Bot parado com sucesso');
            console.log('‚úÖ Bot parado com sucesso');
            
        } catch (error) {
            logger.error('Erro ao parar bot', error);
        }
    }
}

// Inicializar bot
const bot = new WhatsAppBot();

// Manipular sinais do sistema para parada graciosa
process.on('SIGINT', async () => {
    console.log('\nüõë Recebido sinal de interrup√ß√£o...');
    await bot.stop();
    process.exit(0);
});

process.on('SIGTERM', async () => {
    console.log('\nüõë Recebido sinal de termina√ß√£o...');
    await bot.stop();
    process.exit(0);
});

// Manipular erros n√£o capturados
process.on('uncaughtException', (error) => {
    logger.error('Erro n√£o capturado', error);
    console.error('‚ùå Erro n√£o capturado:', error);
});

process.on('unhandledRejection', (reason, promise) => {
    logger.error('Promise rejeitada n√£o tratada', reason);
    console.error('‚ùå Promise rejeitada:', reason);
});

// Exportar inst√¢ncia do bot para uso externo
module.exports = bot;

// Log de inicializa√ß√£o
console.log('üöÄ Iniciando WhatsApp Bot...');
console.log(`üìã Configura√ß√£o: ${config.botInfo.nome} v${config.botInfo.versao}`);
console.log(`üì± N√∫mero do Bot: ${config.numeroBot}`);
console.log(`üë§ Dono: ${config.numeroDono}`);
console.log(`üîß Prefixo: ${config.prefix}`);
console.log(`üåê API Laravel: ${config.laravelApi.enabled ? 'Habilitada' : 'Desabilitada'}`);
console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');